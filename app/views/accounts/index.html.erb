
<%=javascript_include_tag "jquery" %>
<script>jQuery.noConflict();</script>
<%=javascript_include_tag "jquery.dataTables.min" %>

<%= stylesheet_link_tag "jquery.dataTables.min" %>
<%= stylesheet_link_tag "dataTables.bootstrap4.min" %>

<script>

  var dataTable = null;

  function addRows(data) {
    patients = JSON.parse(data);
    counter = 0;
    for (var i = 0; i < patients.length; i++) {
      first_name = patients[i]['given_name'];
      last_name = patients[i]['family_name'];
      gender = patients[i]["gender"];
      birthdate = patients[i]["birthdate"];
      age = patients[i]["age"];
      patient_id = patients[i]["patient_id"];
      account_number = patients[i]["account_number"];
      account_type = patients[i]["account_type"];
      relationship = patients[i]["account_relationship"];
      cover_period_end_date = patients[i]["cover_period_end_date"];
      dataTable.api().row.add([account_number,account_type,relationship,cover_period_end_date, first_name, last_name, gender, birthdate, age]).draw();

      var newRow = dataTable.fnSettings().aoData[counter].nTr;
      url = "showPatDashboard(" + patient_id + ")";
      newRow.setAttribute('onclick',url);
      counter++
    }
  }


  function dataT(){
    dataTable = jQuery('#search_results').DataTable();
  }

  function findPatients() {
    var search_str = document.getElementById('search_words').value;

    if (window.XMLHttpRequest) {// code for IE7+, Firefox, Chrome, Opera, Safari
      xmlhttp=new XMLHttpRequest();
    }else{// code for IE6, IE5
      xmlhttp=new ActiveXObject("Microsoft.XMLHTTP");
    }
    xmlhttp.onreadystatechange=function() {
      if (xmlhttp.readyState==4 && xmlhttp.status==200) {
        var results = xmlhttp.responseText;
        if(results == 'undefined' || results == '' || results == '"not validate"') {
          return;
        }else{
          dataTable.fnClearTable();
          addRows(results);
        }
      }
    }
    xmlhttp.open("GET","/clients_live_search?search_str="+search_str,true);
    xmlhttp.send();
  }


</script>


<div class="search-container">

  <!-- start -->

  <div class="page-head">
    <span>Billing: Active accounts</span>
    <div class='pull-lg-right'>
      <table>
        <tr>
          <td>
            <button class="btn btn-success"
                    style="float: right; marging-right: 5px;" onclick="javascript:location='/company/0'">
              <span class="glyphicon glyphicon-step-backward"></span> Add New Account</button>
          </td>
        </tr>
      </table>
      <br>
      <table>
        <tr>
          <td>
            <input type="text" name="search" onkeyup = "javascript:findPatients()"
                   placeholder = "Client(s) search" id="search_words" />
          </td>
        </tr>
      </table>
    </div>
  </div>
  <section id='modals'>
    <table id="search_results" class="table table-striped table-bordered table-condensed">
      <thead>
      <tr id = 'table_head'>
        <th id="th1" >Account number</th>
        <th id="th1" >Account type</th>
        <th id="th8" >Relationship</th>
        <th id="th8" >Coverage end date</th>
        <th id="th3" >First name</th>
        <th id="th4" >Last name</th>
        <th id="th5" >Gender</th>
        <th id="th5" >Birthdate</th>
        <th id="th8" >Age</th>
      </tr>
      </thead>
      <tbody id='results'>
      <%(@accounts || []).each do |account|
        patient = PatientService.get_patient(account.patient_id)
      %>
          <tr onclick="showPatDashboard(<%=account.patient_id%>);">
            <td><%=account.account_number%></td>
            <td><%=account.health_insurance_plan.health_insurance.name rescue nil%></td>
            <td><%=account.relationship%></td>
            <td><%=account.cover_period_end_date.strftime('%d-%b-%Y')%></td>
            <td><%=patient.given_name%></td>
            <td><%=patient.family_name%></td>
            <td><%=patient.gender%></td>
            <td><%=patient.birthdate.to_date.strftime('%d-%b-%Y') rescue 'N/A'%></td>
            <td><%=patient.age%></td>
          </tr>
      <%end%>
      </tbody>
    </table>
  </section>

  <script>
    dataT();

    function showPatDashboard(patient_id) {
      document.location = '/account/'+patient_id;
    }
  </script>
  <!-- end -->


</div>


